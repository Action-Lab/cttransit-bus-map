<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>CTtransit Bus Positions in Real Time</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
      integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
      crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
      integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
      crossorigin=""></script>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.3.5/papaparse.min.js"></script>

    <style>
      html, body {
        margin: 0;
        padding: 0;
        font-family: Arial;
      }
      #map {
        width: 100vw;
        height: 100vh;
      }
      #schedule {
        position: absolute;
        z-index: 999;
        top: 10px;
        left: 10px;
        background: white;
        padding: 10px 15px;
      }
      span {
        padding: 0 2px;
      }
      a, a:hover, a:visited {
        color: rgb(58, 132, 223);
        text-decoration: none;
        margin-left: 5px;
      }
      a:hover {
        text-decoration: underline;
      }
      .leaflet-popup-content {
        font-size: 16px;
      }
      .bus-icon {
        border: 0;
        font-size: 11px;
        text-align: center;
        line-height: 10px;
      }
      .bus-icon img {
        height: 32px;
      }
      .bus-icon img.downtown {
        -moz-transform: scaleX(-1);
        -o-transform: scaleX(-1);
        -webkit-transform: scaleX(-1);
        transform: scaleX(-1);
        filter: FlipH;
        -ms-filter: "FlipH";
      }
      .bus-icon span {
        z-index: 99999;
      }
    </style>
  </head>

  <body>

    <div id="map"></div>

    <script>
      /**
       * Loads a .geojson file from routes/ and displays it on the map
       */
      function addRoute(number, color) {
        $.getJSON('routes/' + number + '.geojson', function(data) {
          var route = L.geoJSON(data, {style: {
              color: color,
              weight: 5,
              opacity: 0.8
            }
          }).addTo(map);

          route.on('click', function(e) {
            L.DomEvent.stopPropagation(e);    // this is needed to prevent opening map's (not geojson's) popup
            openPopup(e, 'Bus Route ' + number);
          });
        });
      };

      addRoute('37-39', '#8000FF');
      addRoute('41', '#FF0000');
      addRoute('61', '#FF0000');

      // Only display the following route_ids:
      var routesToDisplay = ['9005', '9131', '9134', '9008', '9021', '9147'];

      var trinCoords = [41.7479, -72.6903];
      var map = L.map('map').setView(trinCoords, 14);

      var baseLayer = L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/terrain/{z}/{x}/{y}.jpg');
      baseLayer.addTo(map);

      var trinity = L.marker(trinCoords, {
        icon: L.icon({
          iconUrl: 'trinity.png',
          iconSize: [48, 48]
        })
      })
      .bindPopup('<h3>Trinity College</h3> 300 Summit St <br> Hartford CT <br> 06106')
      .addTo(map);

      var routesData = {};
      var tripsData = {};
      var stopsData = {};

      // Load routes.txt to get bus number and colors by route_id
      $.get('gtfs/routes.txt', function(fileData) {
        Papa.parse(fileData, {
          header: true,
          complete: function(data) {
            for (i in data.data) {
              routesData[data.data[i].route_id] = data.data[i];
            }

            // Load trips.txt to get direction and trip_headsign by trip_id
            $.get('gtfs/trips.txt', function(fileData) {
              Papa.parse(fileData, {
                header: true,
                complete: function(data) {
                  for (i in data.data) {
                    tripsData[data.data[i].trip_id] = data.data[i];
                  }
                  updatePositions();
                  addTrinityStops();
                }
              })
            });
          }
        });
      });

      function addTrinityStops() {
        var busStops = [
          {
            id: '2153',
            name: 'New Britain Ave and Trinity Skating Ring',
            lat: 41.744452,
            lon: -72.688232
          },
          {
            id: '2002',
            name: 'New Britain Ave and Opp Newbury St',
            lat: 41.742704,
            lon: -72.691724
          },
          {
            id: '592',
            name: 'Broad St and Opp Cresent St',
            lat: 41.745925,
            lon: -72.687018
          },
          {
            id: '597',
            name: 'Broad St and Vernon St',
            lat: 41.751404,
            lon: -72.686959
          }
        ];

        var busStopIcon = L.icon({
          iconUrl: 'bus-stop.png',
          iconSize: [32, 32],
          iconAnchor: [16, 32]
        });

        var busStopsMarkers = [];

        for (i in busStops) {
          var s = busStops[i];
          busStopsMarkers.push(new L.marker([s.lat, s.lon], {icon: busStopIcon}).addTo(map));
        }

        function formatSchedule(data) {
          data = data.slice(0,9);
          data.sort(function(a, b) {
            if (a.arrival_time < b.arrival_time) return -1;
            if (a.arrival_time > b.arrival_time) return 1;
            return 0;
          });

          var result = '';
          for (i in data) {
            result += data[i].arrival_time.substring(0,5) + ' <span style="color:white;background:#' + routesData[tripsData[data[i].trip_id].route_id].route_color + '">'  + routesData[tripsData[data[i].trip_id].route_id].route_short_name + '</span><br>';
          }
          return result;
        }
/*
        $.get('gtfs/stop_times.txt', function(file) {
          Papa.parse(file, {
            header: true,
            complete: function(data) {
              for (i in data.data) {
                var p = data.data[i];
                if ( $.inArray(p.stop_id, busStops.map(function(x) {return x.id})) > -1 ) {
                  if ( $.inArray(tripsData[p.trip_id].route_id, routesToDisplay) > -1 ) {
                    if (!stopsData[p.stop_id]) {
                      stopsData[p.stop_id] = [];
                    }
                    stopsData[p.stop_id].push(p);
                  }
                }
              }
              //
              for (i in busStopsMarkers) {
                var m = busStopsMarkers[i];
                m.bindPopup(formatSchedule(stopsData[busStops[i].id]));
              }
            }
          });
        }); */
      };

      var jsonUrl = 'https://ilyankou.domains.trincoll.edu/cttransit';
      var vehicles = {};

      function updatePositions() {
        $.getJSON(jsonUrl, function(data) {
          for (i in data.entity) {
            var obj = data.entity[i];

            if ($.inArray(obj.vehicle.trip.route_id, routesToDisplay) == -1) continue;

            var lat = obj.vehicle.position.latitude;
            var lng = obj.vehicle.position.longitude;

            if (!vehicles[obj.id]) {
              var busNumber = routesData[obj.vehicle.trip.route_id].route_short_name;
              var bgColor = '#' + routesData[obj.vehicle.trip.route_id].route_color;
              var textColor = '#' + routesData[obj.vehicle.trip.route_id].route_text_color;

              var direction = 0;
              if (tripsData[obj.vehicle.trip.trip_id]) {
                direction = tripsData[obj.vehicle.trip.trip_id].direction_id;
              }

              var glyphContent = '\
                <span style="\
                  background:' + bgColor + ';\
                  color:' + textColor + ';\
                  ">' + busNumber + '</span>\
                <br>\
                <img src="bus.png" ' + (direction == '1' ? '' : ' class="downtown"') + '>';

              var glyph = L.divIcon({
                html: glyphContent,
                iconSize: [40, 40],
                iconAnchor: [20, 20],
                className: 'bus-icon',
              });

              var popup = 'Bus ' + tripsData[obj.vehicle.trip.trip_id].trip_headsign;
              vehicles[obj.id] = L.marker([lat, lng], {icon: glyph}).addTo(map).bindPopup(popup);
            }

            vehicles[obj.id].setLatLng(new L.latLng(lat, lng));
          }
        }).fail(function() {console.log('Cannot load data')});
        setTimeout(updatePositions, 10000);
      }

    </script>

  </body>
</html>
